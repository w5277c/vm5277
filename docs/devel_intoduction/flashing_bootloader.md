# Прошивка бутлоадера j8bmb

Перед использованием утилиты j8bf для прошивки ваших программ на микроконтроллер, на устройство необходимо установить специальный бутлоадер (загрузчик) VM5277.  
Этот бутлоадер занимает небольшую область памяти в конце Flash (обычно 512-1024 байта) и позволяет обновлять прошивку через всего один пин МК.

## Что такое бутлоадер VM5277?

Бутлоадер — это небольшая программа, которая:
* Остается в памяти МК постоянно (записывается один раз)
* Занимает последние 512-1024 байта Flash в зависимости от модели МК
* Позволяет прошивать основную программу через UART-интерфейс
* Предоставляет дополнительные функции: проверка прошивки, уникальная идентификация устройства, работа с зашифрованными прошивками и т.п.
* Автоматически запускает основную программу при включении питания, если не получена команда на вход в режим загрузчика

## Зачем нужен бутлоадер?
* Упрощение разработки — не нужен внешний программатор после первоначальной установки
* Минимальное подключение — требуется всего 1 пин МК (часто используется пин RESET)
* Быстрая прошивка — интеллектуальное обновление только измененных страниц
* Дополнительные возможности — уникальный ID устройства, версионирование прошивки и т.п.
* Кроссплатформенность — одна утилита работает с разными семействами МК

## Что такое фьюзы (fuses) на AVR?

Фьюзы — это специальные биты конфигурации, хранящиеся в отдельной энергонезависимой памяти микроконтроллера. Они:
* Устанавливаются обычно один раз при первоначальной настройке МК
* Не изменяются при обычном программировании Flash-памяти
* Определяют аппаратные настройки работы микроконтроллера
* Требуют осторожности — неправильные настройки могут "заблокировать" МК

## Утилита j8bmb (mkboot)

Для создания и прошивки бутлоадера используется утилита j8bmb (сокращение от "make bootloader"). Ее задача сформировать прошивку-бутлоадер специально сформированную под конкретно указанный МК и конкретно указанные параметры (например используемый PIN для подключения)

### Основной синтаксис:
```bash
j8bmb <платформа>:<микроконтроллер> [опции]
```
### Ключевые опции:
* **-P, --path <директория>** — указать пользовательский путь к тулкит
* **-p, --pin <имя_пина>** — указать пин для бутлоадера (формат: "PA0", "PB3", "RESET")
* **-k, --key <hex_данные>** — ключ шифрования прошивки (32 байта)
* **-s, --secure <asm_файл>** — файл с функциями шифрования для защищенного бутлоадера
* **-u, --uid <hex_данные>** — уникальный идентификатор устройства (8 байт)
* **-m, --uidmode <режим>** — способ генерации UID: local, global, param
* **-o, --overwrite** — разрешить перезапись существующего UID в локальной базе

### Простейший пример использования:
```bash
j8bmb avr:atmega328p -p PC2
```

Здесь будет сформирован hex-файл прошивки для платформы AVR и чипа ATmega328p, будет задейстован пин `PC2`,
а UID будет сформирован случайно используя локальную базу - текстовой файл в директории `var/uids.db` проекта.  

### Пример успешного выполнения:
```bash
;j8b mkboot: bootloader firmware generator for vm5277 Embedded Toolkit
;Version: 0.1 | License: Apache-2.0
;================================================================
;WARNING: This project is under active development.
;The primary focus is on functionality; testing is currently limited.
;Please report any bugs found to: konstantin@5277.ru
;================================================================
Toolkit path: /home/kostas/vm5277

--CODE-----------------------------------
 Start	= 3E00, End = 3F8E, Length = 018F
 -----
 Total	:  399 words (798 bytes) 2.4%

parsed: 0 lines
Build SUCCESS, warnings:0

#-------------------------------------------------------------------------------------------
#    *** CRITICAL INFORMATION ***
#-------------------------------------------------------------------------------------------
# Platform:                 avr
# MCU:                      atmega328p
# Device signature:         001e950f
# Bootloader version:       64
# Device unique identifier: 30e06d7c2c9c673a

#-------------------------------------------------------------------------------------------
#    *** CRITICAL SECURITY WARNINGS ***
#-------------------------------------------------------------------------------------------
# 1. CRITICAL INFORMATION IS REQUIRED FOR:
#    Identifying this specific device
#    Generating encrypted firmware (if using the key)
# 2. FIRMWARE GENERATED WITH THIS DATA:
#    Is for ONE MCU ONLY — do not reuse
#    MUST NEVER be distributed/shared
#    May contain the decryption key in plain binary form
# 3. INFORMATION LOCALLY STORED:
#    Critical information has been saved to: /home/kostas/vm5277/var/uids.db
#    Keep this file secure - contains sensitive device identification data.
------------------------------------------------------------------------
```
Более подробную информацию смотрите [утилиту j8bmb](j8bmb.md) — работа с утилитой формирования бутлоадера, флаги, настройка, режимы работы.

## Процесс прошивки бутлоадера
### Шаг 1: Подготовка оборудования
* USB-UART адаптер — любой распространенный преобразователь (CH340, CP2102, FT232)
* Подключение к МК — соедините `TX+RX` адаптера вместе и подключите к выбранному пину МК  
*вероятно потребуется внешний подтягивающий резистор к VCC на 10К, агалогичо тербованию МК к пину RESET*

| USB-UART адаптер | МК (ATmega328P) |
|----------|-------------------|
| TX+RX (соединены) | PC2 |
| GND | GND |

* Программатор — для первой прошивки потребуется стандартный программатор (например USBasp для AVR)

### Шаг 2: Создание образа бутлоадера
```bash
j8bmb avr:atmega328p -p PC2
```

Утилита выполнит:
* Проверку доступности необходимых файлов в тулките
* Генерацию уникального ID устройства (UID)
* Компиляцию бутлоадера с учетом указанных параметров и типа МК
* Сохранение критической информации (UID, ключи) в локальную базу
* Пропишет использование пина PC2

### Шаг 3: Прошивка бутлоадера программатором
Используйте стандартные утилиты для прошивки сгенерированного HEX-файла:

**Для AVR через USBasp:**
```bash
avrdude -p atmega328p -c usbasp -P usb -U flash:w:target/bootloader.hex:i
```
Вот описание работы с [стандартными утилитами](flashing_external.md)  

### Шаг 4: Установка Fuse битов
После прошивки бутлоадера необходимо настроить фьюзы микроконтроллера для правильной работы МК.  
Это стандартаня практика работы с AVR микроконтроллерами, вот необходимые нам фьюзы ATmega328P:
* Источник тактирования и его частота (CKSEL0-3: 1111 - для внешнего кварца на 16МГц)
* Отключить делитель x8 (CKDIV8:1)
* Задать режим запуска с бутлоадера (BOOTRST:0) и его размер (BOOTSZ0-1:10)
* **Если используем пин RESET: перевести RESET пин в режим GPIO (RSTDISBL:0)**  
**ВНИМАНИЕ! Необходимо быть очень осторожным - установка фьюза RSTDISBL в 0 блокирует работу пина RESET!**  
**Без высоковольного программатора (12v) или установленного бутлоадера этот бит восстановить нельзя!**  
**Аналогично не получится повлиять на значения других фьюзов и прошить что-либо стандартным программатором.**

Информацию о значениях байт фьюз бит можно почерпнуть в интеренете, например на ресурсах:
* [ресурс](http://homes-smart.ru/fusecalc/?prog=avrstudio&part=ATmega88P)  
* [ресурс](https://fusecalc.mirmk.ru/)  
* [ресурс](https://radioaktiv.ru/avr_fuses_calculator.html?part=ATmega328P)  
*В будущем утилита j8mb будет генерировать специальный информационный блок с описанием необходимых состояний фьюзов и будет предлагать необходимые параметры для стандартного программатора.*


### Шаг 5: Проверка установки
После прошивки бутлоадера можно проверить его работу:
* Подключите USB-UART адаптер (TX+RX вместе) к выбранному пину МК
* Запустите проверку соединения не указывая никаких дополнительных опций:
```bash
j8bf avr:atmega328p 16
```
* Если компоненты тулкита отработали корректно, вы увидите информацию об устройстве

## Особенности и ограничения
### Размер бутлоадера:
* **512 байт** — для МК которые не поддерживают защищенную область Flash для бутлоадера,  
или просто имеют небольшой объемом Flash (ATtiny, некоторые ATmega)
* **1024 байта** — для большинства ATmega, включает дополнительные функции (возможность работы с зашифрованной прошивкой)

### Поддерживаемые пины:
* **RESET** — используется по умолчанию, если поддерживает GPIO
* **Любой GPIO** — можно указать любой свободный пин (PA0-PA7, PB0-PB7, и т.д.)

### Шифрование прошивки:
* Требует аппаратной поддержки защищенной области памяти на МК
* Ключ шифрования обязательно нужно сохранить и хранить надежно — без него нельзя обновить прошивку
* Умный режим прошивки (-s) недоступен при использовании шифрования

### Уникальные идентификаторы (UID):
* **Local mode** — UID генерируется случайно и сохраняется локально (рекомендуется для разработки)
* **Global mode** — UID запрашивается у основного сервера тулкита (требуется регистрация)
* **Param mode** — UID задается вручную (для специфических случаев)

## Советы для начинающих
* Начните с простого — сначала используйте бутлоадер без шифрования
* Используйте любой GPIO — например PC2
* Сохраните информацию — после генерации бутлоадера сохраните выведенную информацию (UID, ключи)
* Однажды установлен — всегда работает — бутлоадер остается в памяти и не стирается при обновлении утилитой j8bf основной прошивки 
* При проблемах — проверьте подключение, тактовую частоту МК и правильность указанного пина


## Что если нужно удалить бутлоадер?
* Используйте стандартный программатор для записи новой прошивки и/или измените состояние фьюзов отвечающих за приоритетный старт бутлоадера.
* Иными словами рассматривайте чип как новый но не забудьте проверить состояние фьюз битов.
* **Для восстановления фьюз бита RSTDISBL будет реализована специальная поддержка на уровне бутлоадера и утилиты j8bf**

[← Назад к содержанию](index.md)




